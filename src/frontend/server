"""
Simple Flask API Server for CodeMentor AI
Connects the frontend to the production agent
"""

from flask import Flask, request, jsonify
from flask_cors import CORS
import sys
import os

# Add parent directories to path
current_dir = os.path.dirname(os.path.abspath(__file__))
backend_dir = os.path.join(current_dir, '..')
src_dir = os.path.join(backend_dir, '..')
sys.path.insert(0, src_dir)

from backend.ai.production_agent import ProductionAgent

app = Flask(__name__)
CORS(app)  # Enable CORS for frontend requests

# Initialize agent (only once)
print("Initializing CodeMentor AI agent...")
agent = ProductionAgent(cost_limit=10.0)  # $10 limit
print("Agent ready!")

@app.route('/')
def home():
    """Home page"""
    return jsonify({
        'message': 'CodeMentor AI Backend',
        'version': '1.0',
        'endpoints': {
            '/api/query': 'POST - Send query to AI agent',
            '/api/health': 'GET - Health check',
            '/api/stats': 'GET - Get usage statistics'
        }
    })

@app.route('/api/health', methods=['GET'])
def health_check():
    """Health check endpoint"""
    return jsonify({
        'status': 'ok',
        'agent': 'ready',
        'cost_remaining': agent.cost_tracker.cost_limit - agent.cost_tracker.total_cost
    })

@app.route('/api/query', methods=['POST'])
def handle_query():
    """
    Handle user queries from frontend
    
    Request body:
    {
        "query": "What problem should I practice next?",
        "user_id": "user_001"
    }
    
    Response:
    {
        "success": true,
        "message": "AI response...",
        "execution_time": 1.23,
        "cost_summary": {...}
    }
    """
    try:
        data = request.json
        
        if not data:
            return jsonify({
                'success': False,
                'message': 'Request body is required'
            }), 400
        
        query = data.get('query', '').strip()
        user_id = data.get('user_id', 'user_001')
        
        if not query:
            return jsonify({
                'success': False,
                'message': 'Query cannot be empty. Please ask a question!'
            }), 400
        
        # Input validation
        if len(query) > 10000:
            return jsonify({
                'success': False,
                'message': 'Query too long. Maximum 10,000 characters.'
            }), 400
        
        print(f"\n[{user_id}] Query: {query[:100]}...")
        
        # Send to agent
        result = agent.send_message(query, user_id=user_id)
        
        print(f"[{user_id}] Response: {'Success' if result['success'] else 'Failed'}")
        
        return jsonify(result)
    
    except Exception as e:
        print(f"Error in /api/query: {str(e)}")
        import traceback
        traceback.print_exc()
        
        return jsonify({
            'success': False,
            'message': 'Internal server error. Please try again.',
            'error_type': type(e).__name__
        }), 500

@app.route('/api/stats', methods=['GET'])
def get_stats():
    """Get usage statistics"""
    return jsonify({
        'cost_summary': agent.cost_tracker.get_summary(),
        'circuit_breakers': {
            tool: {'state': cb.state, 'failures': cb.failure_count}
            for tool, cb in agent.circuit_breakers.items()
        }
    })

@app.route('/api/reset', methods=['POST'])
def reset_agent():
    """Reset agent (clear conversation history)"""
    global agent
    agent = ProductionAgent(cost_limit=10.0)
    return jsonify({
        'success': True,
        'message': 'Agent reset successfully'
    })

if __name__ == '__main__':
    print("\n" + "="*60)
    print("CodeMentor AI Backend Server")
    print("="*60)
    print("\nServer starting on http://localhost:5000")
    print("\nEndpoints:")
    print("  GET  /              - API info")
    print("  GET  /api/health    - Health check")
    print("  POST /api/query     - Send query to AI")
    print("  GET  /api/stats     - Usage statistics")
    print("  POST /api/reset     - Reset conversation")
    print("\nFrontend: Open index.html in your browser")
    print("="*60 + "\n")
    
    app.run(
        debug=True,
        port=5000,
        host='0.0.0.0'  # Allow external connections
    )
